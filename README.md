# README
Create a parquet files using polars and pandas.

Then we read these created parquet files with polars (polars and pyarrow backend) and pandas (pyarrow backend).
I skipped the option to use fastparquet as a backend with pandas as it is very slow.

## Run locally:
I create a virtual environment with python 3.12.8, activate it and install dependencie with poetry:
```bash
poetry lock --no-update && poetry install --no-root
```

then create the parquet files running:
```bash
python create_parquet_files.py
```
which will write the parquet file into a folder `synthetic_parquet_files`.

Then read the files multiple times, checking for changes in the read values by running
```bash
python test_read_parquet_file.py
```

Subsequently analyse the data running
```bash
python analysis_script.py
```

## Build and Run in Docker
You need to be in to root directory of this project, as we mount the project folder as a volume in the docker container
```bash
docker build -t parquet_checker .
docker run -d -v $(pwd):/app parquet_checker
```

## Example Terminal Output creating parquet files running create_parquet_files.py
Generating the files with pandas shows that parquet format_version: 2.6 is used while polars creates parquet files using format_version: 1.0.

```
(.venv)$ python create_parquet_files.py
Generating 1 parquet files with 20 entries each...
Each entry contains a list of 1,500,000 floats
Output directory: synthetic_parquet_files
Estimated total size: 0.11 GB (uncompressed)
This will generate approximately 0.11 GB of data.
Generating files: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00<00:00, 18236.10it/s]
########################################################
pandas
########################################################

Generated 1 parquet files in synthetic_parquet_files

Verifying structure of first file...
Shape: (100, 3)
Columns: ['date', 'value', 'value2']
First date: 1672531200
Length of first value array: 1500000

Polars shape: (100, 3)
<pyarrow._parquet.FileMetaData object at 0x7dea2aba4630>
  created_by: parquet-cpp-arrow version 17.0.0
  num_columns: 3
  num_rows: 100
  num_row_groups: 1
  format_version: 2.6
  serialized_size: 2209

########################################################
polars
########################################################

Generated 1 parquet files in synthetic_parquet_files

Verifying structure of first file...
Shape: (100, 3)
Columns: ['date', 'value', 'value2']
First date: 1672531200
Length of first value array: 1500000

Polars shape: (100, 3)
<pyarrow._parquet.FileMetaData object at 0x7dea2aba4310>
  created_by: Polars
  num_columns: 3
  num_rows: 100
  num_row_groups: 1
  format_version: 1.0
  serialized_size: 981
```


## Example (Representative) Terminal Output when running test_read_parquet_file.py

The parquet files that were generated by polars lead to violations when loaded with polars_pyarrow and polars_rust (own polars engine) but not if they are loaded with pandas_pyarrow.
The parquet files that were generated by pandas, never lead to any violations.

**So there is only an issue if files are generated with polars (format_version: 1.0) AND read with polars!
**
```
(.venv)$ python test_read_parquet_file.py
####################################################################################################################################################################################
####################################################################################################################################################################################
loading parquet files created with polars:
####################################################################################################################################################################################
####################################################################################################################################################################################
-------------------------------------------------------------
checking polars_rust
-------------------------------------------------------------
polars_rust, hashes differ for file synthetic_parquet_files/polars/data_000.parquet
Precision violation found for 5 elements
polars_rust, hashes differ for file synthetic_parquet_files/polars/data_000.parquet
Precision violation found for 5 elements
polars_rust, hashes differ for file synthetic_parquet_files/polars/data_000.parquet
Precision violation found for 1 elements
polars_rust, hashes differ for file synthetic_parquet_files/polars/data_000.parquet
Precision violation found for 1 elements
polars_rust, hashes differ for file synthetic_parquet_files/polars/data_000.parquet
Precision violation found for 1 elements
polars_rust, hashes differ for file synthetic_parquet_files/polars/data_000.parquet
Precision violation found for 1 elements
polars_rust, hashes differ for file synthetic_parquet_files/polars/data_000.parquet
Precision violation found for 1 elements
polars_rust, hashes differ for file synthetic_parquet_files/polars/data_000.parquet
Precision violation found for 1 elements
polars_rust, hashes differ for file synthetic_parquet_files/polars/data_000.parquet
Precision violation found for 1 elements
polars_rust, hashes differ for file synthetic_parquet_files/polars/data_000.parquet
Precision violation found for 1 elements
polars_rust, hashes differ for file synthetic_parquet_files/polars/data_000.parquet
Precision violation found for 1 elements
Precision violation found for 9 elements
polars_rust, hashes differ for file synthetic_parquet_files/polars/data_000.parquet
Precision violation found for 1 elements
Precision violation found for 9 elements
polars_rust, hashes differ for file synthetic_parquet_files/polars/data_000.parquet
Precision violation found for 18 elements
polars_rust, hashes differ for file synthetic_parquet_files/polars/data_000.parquet
Precision violation found for 18 elements
Processing polars_rust Files: 100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1/1 [05:41<00:00, 341.96s/it]
number of violation events 16
number of errors reading files 0
-------------------------------------------------------------
checking pandas_pyarrow
-------------------------------------------------------------
Processing pandas_pyarrow Files: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1/1 [01:55<00:00, 115.86s/it]
number of violation events 0
number of errors reading files 0
-------------------------------------------------------------
checking polars_pyarrow
-------------------------------------------------------------
polars_pyarrow, hashes differ for file synthetic_parquet_files/polars/data_000.parquet
Precision violation found for 1 elements
polars_pyarrow, hashes differ for file synthetic_parquet_files/polars/data_000.parquet
Precision violation found for 1 elements
polars_pyarrow, hashes differ for file synthetic_parquet_files/polars/data_000.parquet
Precision violation found for 9 elements
polars_pyarrow, hashes differ for file synthetic_parquet_files/polars/data_000.parquet
Precision violation found for 9 elements
polars_pyarrow, hashes differ for file synthetic_parquet_files/polars/data_000.parquet
Precision violation found for 2 elements
polars_pyarrow, hashes differ for file synthetic_parquet_files/polars/data_000.parquet
Precision violation found for 2 elements
Processing polars_pyarrow Files: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1/1 [05:49<00:00, 349.47s/it]
number of violation events 6
number of errors reading files 0

####################################################################################################################################################################################
####################################################################################################################################################################################
loading parquet files created with pandas:
####################################################################################################################################################################################
####################################################################################################################################################################################
-------------------------------------------------------------
checking polars_rust
-------------------------------------------------------------
Processing polars_rust Files: 100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1/1 [05:01<00:00, 301.90s/it]
number of violation events 0
number of errors reading files 0
-------------------------------------------------------------
checking pandas_pyarrow
-------------------------------------------------------------
Processing pandas_pyarrow Files: 100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1/1 [01:24<00:00, 84.34s/it]
number of violation events 0
number of errors reading files 0
-------------------------------------------------------------
checking polars_pyarrow
-------------------------------------------------------------
Processing polars_pyarrow Files: 100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1/1 [05:15<00:00, 315.23s/it]
number of violation events 0
number of errors reading files 0
```

## Example Terminal Output analysing results running analysis_script.py
